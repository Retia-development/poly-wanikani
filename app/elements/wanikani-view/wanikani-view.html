<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="wanikani-view">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>
    <wanikani-data items="{{items}}"></wanikani-data>
      <paper-dialog modal="true" id="authView" entry-animation="scale-up-animation" exit-animation="fade-out-animation" opened="{{!isAuthenticated}}" autoFitOnAttach="true">
        <form is="iron-form" id="form">
          <paper-input label="API Key" name="key" required autofocus></paper-input>
        </form>
      </paper-dialog>

      <paper-header-panel class="fit">
        <paper-toolbar id="mainToolbar">
          <span class="flex"></span>

          <paper-icon-button icon="refresh"></paper-icon-button>
          <div class="middle middle-container center horizontal layout">
            <div class="app-name">poly wanikani</div>
          </div>
        </paper-toolbar>

        <div class="content fit">
          <wanikani-exercise item="[[randomItem]]" class="fit" on-correct-answer="_setRandomItem" on-wrong-answer="handleWrongAnswer"></wanikani-exercise>
        </div>
      </paper-header-panel>
  </template>
  <script>
  (function(window) {
    'use strict';

    Polymer({
      is: 'wanikani-view',
      listeners: {
        'iron-form-submit': '_getItems'
      },
      properties: {
        apiKey: {
          type: String,
          value: null
        },
        isAuthenticated: {
          type: Boolean,
          computed: '_isAuthenticated(apiKey)'
        },
        items: {
          type: Array,
          observer: '_setRandomItem'
        },
        randomItem: {
          type: Object
        }
      },
      handleWrongAnswer: function(e, rightAnswer) {
        window.alert('The correct answer was: ' + rightAnswer);
        this._setRandomItem();
      },
      _getItems: function(e, data) {
        this.apiKey = data.key;
      },
      _isAuthenticated: function() {
        return typeof(this.apiKey) === 'string';
      },
      _setRandomItem: function() {
        this.randomItem = this._getRandomItem(this.items);
      },
      _getRandomItem: function(items) {
        return _.isArray(items) ? _.sample(items) : null;
      }
    });
  })(window);
  </script>
</dom-module>
